<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Assistant - Scrum Master AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .agent-selector {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .agent-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }

        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
        }

        .message.user {
            background: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .message.assistant .agent-name {
            font-weight: 600;
            color: #4f46e5;
            font-size: 12px;
            margin-bottom: 4px;
        }

        /* Markdown formatting styles */
        .message h1, .message h2, .message h3 {
            color: #1e293b;
            margin: 16px 0 8px 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .message h1:first-child, .message h2:first-child, .message h3:first-child {
            margin-top: 0;
        }

        .message h1 { font-size: 18px; }
        .message h2 { font-size: 16px; }
        .message h3 { font-size: 14px; }

        .message strong {
            font-weight: 600;
            color: #1e293b;
        }

        .message ul, .message ol {
            margin: 12px 0;
            padding-left: 20px;
        }

        .message li {
            margin: 2px 0;
            line-height: 1.4;
        }

        .message p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .message p:first-child {
            margin-top: 0;
        }

        .message p:last-child {
            margin-bottom: 0;
        }

        .message table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
            font-size: 13px;
        }

        .message th, .message td {
            border: 1px solid #e2e8f0;
            padding: 6px 8px;
            text-align: left;
        }

        .message th {
            background: #f1f5f9;
            font-weight: 600;
        }

        .message code {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }

        .message blockquote {
            border-left: 3px solid #4f46e5;
            margin: 8px 0;
            padding-left: 12px;
            color: #64748b;
            font-style: italic;
        }

        .message hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 12px 0;
        }

        .input-area {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .input-container button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .input-container button:hover:not(:disabled) {
            background: #4338ca;
        }

        .input-container button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-style: italic;
            padding: 12px 16px;
        }

        .loading::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 10px;
            background: #dcfce7;
            color: #166534;
            font-size: 12px;
            border-bottom: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border-bottom-color: #fca5a5;
        }

        /* File upload styles */
        .file-upload-area {
            position: relative;
        }

        .file-drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone.drag-over {
            border-color: #4f46e5;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .file-drop-zone:hover {
            border-color: #94a3b8;
            background: #f1f5f9;
        }

        .file-drop-zone p {
            color: #64748b;
            margin: 8px 0;
            font-size: 14px;
        }

        .file-drop-zone .drop-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .file-input {
            display: none;
        }

        .file-preview {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .file-preview .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .file-preview .file-content {
            background: white;
            padding: 8px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 120px;
            overflow-y: auto;
            color: #374151;
            font-size: 12px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .file-actions button {
            padding: 4px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            background: white;
            color: #374151;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-actions button:hover {
            background: #f8fafc;
        }

        .file-actions button.primary {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .file-actions button.primary:hover {
            background: #4338ca;
        }

        .file-error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .file-attachment-info {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            text-align: center;
        }

        .file-attachment-info p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ SM Assistant</h1>
            <p>Your AI-powered Scrum Master companion</p>
        </div>
        
        <div class="status" id="status">
            Connecting to SM Assistant...
        </div>

        <div class="agent-selector">
            <select id="agentSelect">
                <option value="general">üéØ General Scrum Master</option>
                <option value="backlog">üìã Backlog Intelligence</option>
                <option value="meetings">üó£Ô∏è Meeting Intelligence</option>
                <option value="metrics">üìä Flow Metrics</option>
                <option value="wellness">üíö Team Wellness</option>
                <option value="coaching">üöÄ Agile Coaching</option>
            </select>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="message assistant">
                <div class="agent-name">SM Assistant</div>
                <div>Hello! I'm your AI Scrum Master Assistant. I can help you with user stories, meeting analysis, team metrics, wellness monitoring, and agile coaching. What would you like to work on today?</div>
            </div>
        </div>

        <div class="input-area">
            <div class="file-upload-area">
                <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="drop-icon">üìÅ</div>
                    <p><strong>Drop files here or click to browse</strong></p>
                    <p>Supports: .txt, .md, .json, .csv (max 1MB)</p>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.md,.json,.csv" />
                <div id="filePreview" style="display: none;"></div>
                <div id="fileError" style="display: none;"></div>
            </div>
            
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    placeholder="Ask me about user stories, sprint planning, team metrics, or anything scrum-related... (Attach files by dragging them above)"
                    rows="1"
                ></textarea>
                <button id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let isLoading = false;
        let sessionId = null;

        // Improved markdown to HTML converter
        function formatMarkdown(text) {
            // First, clean up excessive whitespace
            text = text
                .replace(/\n{3,}/g, '\n\n')  // Reduce multiple newlines to max 2
                .replace(/[ \t]+$/gm, '')    // Remove trailing spaces
                .trim();
            
            return text
                // Headers (must be at start of line)
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                
                // Code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                
                // Horizontal rules (must be on own line)
                .replace(/^---+$/gm, '<hr>')
                
                // Tables - improved handling
                .replace(/\|(.+)\|/g, (match, content) => {
                    const cells = content.split('|').map(cell => cell.trim());
                    // Skip separator rows (contain dashes)
                    if (cells.some(cell => cell.match(/^-+$/))) {
                        return '';
                    }
                    // Skip empty rows
                    if (cells.every(cell => !cell)) {
                        return '';
                    }
                    const cellTags = cells.map(cell => `<td>${cell}</td>`).join('');
                    return `<tr>${cellTags}</tr>`;
                })
                
                // Wrap tables and fix headers
                .replace(/(<tr>.*?<\/tr>(?:\s*<tr>.*?<\/tr>)*)/gs, (match) => {
                    const rows = match.split('</tr>').filter(row => row.trim());
                    if (rows.length === 0) return '';
                    
                    // Convert first row to headers
                    const firstRow = rows[0] + '</tr>';
                    const headerRow = firstRow.replace(/<td>/g, '<th>').replace(/<\/td>/g, '</th>');
                    const bodyRows = rows.slice(1).map(row => row + '</tr>').join('');
                    
                    return `<table>${headerRow}${bodyRows}</table>`;
                })
                
                // Lists - improved detection
                .replace(/^(\s*)[-*+]\s+(.+)$/gm, '$1<li>$2</li>')
                .replace(/^(\s*)\d+\.\s+(.+)$/gm, '$1<li>$2</li>')
                
                // Wrap consecutive list items in ul/ol tags
                .replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs, '<ul>$1</ul>')
                
                // Blockquotes
                .replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>')
                
                // Convert double line breaks to paragraphs, single to breaks
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>')
                
                // Wrap in paragraph tags and clean up
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                
                // Clean up empty paragraphs and excessive breaks
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-6]>)/g, '$1')
                .replace(/(<\/h[1-6]>)<\/p>/g, '$1')
                .replace(/<p>(<hr>)<\/p>/g, '$1')
                .replace(/<p>(<table>)/g, '$1')
                .replace(/(<\/table>)<\/p>/g, '$1')
                .replace(/<p>(<ul>)/g, '$1')
                .replace(/(<\/ul>)<\/p>/g, '$1')
                .replace(/(<br>){3,}/g, '<br><br>')
                
                // Final cleanup
                .replace(/\s+/g, ' ')  // Normalize spaces
                .trim();
        }

        // Check system status on load
        async function checkStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const status = document.getElementById('status');
                if (data.status === 'healthy' && data.openai_available) {
                    status.textContent = `‚úÖ Connected - ${data.agents_loaded} agents ready`;
                    status.className = 'status';
                } else {
                    status.textContent = '‚ö†Ô∏è Connected but OpenAI unavailable - Demo mode';
                    status.className = 'status error';
                }
            } catch (error) {
                const status = document.getElementById('status');
                status.textContent = '‚ùå Connection failed - Check backend';
                status.className = 'status error';
            }
        }

        // Send message function
        async function sendMessage() {
            if (isLoading) return;

            const input = document.getElementById('messageInput');
            const agentSelect = document.getElementById('agentSelect');
            const chatArea = document.getElementById('chatArea');
            const sendButton = document.getElementById('sendButton');

            const message = input.value.trim();
            if (!message && !currentFileContent) return;

            // Add user message with file attachment indicator
            const userDiv = document.createElement('div');
            userDiv.className = 'message user';
            
            let displayMessage = message;
            if (currentFileContent && currentFileName) {
                displayMessage = `üìé ${currentFileName}\n${message || 'Please analyze this file.'}`;
            }
            
            userDiv.textContent = displayMessage;
            chatArea.appendChild(userDiv);

            // Clear input and show loading
            input.value = '';
            isLoading = true;
            sendButton.disabled = true;

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Thinking...';
            chatArea.appendChild(loadingDiv);

            chatArea.scrollTop = chatArea.scrollHeight;

            try {
                // Initialize session if not already done
                if (!sessionId) {
                    await initializeSession();
                }

                // Prepare the request payload
                const payload = {
                    message: message || 'Please analyze the attached file.',
                    agent_type: agentSelect.value,
                    session_id: sessionId
                };

                // Include file content if attached
                if (currentFileContent && currentFileName) {
                    payload.attached_file = {
                        filename: currentFileName,
                        content: currentFileContent
                    };
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Update session ID if provided
                if (data.session_id) {
                    sessionId = data.session_id;
                }

                // Remove loading
                chatArea.removeChild(loadingDiv);

                // Add assistant response
                const assistantDiv = document.createElement('div');
                assistantDiv.className = 'message assistant';
                assistantDiv.innerHTML = `
                    <div class="agent-name">${data.agent || 'SM Assistant'}</div>
                    <div>${formatMarkdown(data.response)}</div>
                `;
                chatArea.appendChild(assistantDiv);

                // Clear file attachment after successful message
                if (currentFileContent) {
                    clearFilePreview();
                }

            } catch (error) {
                chatArea.removeChild(loadingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message assistant';
                errorDiv.innerHTML = `
                    <div class="agent-name">Error</div>
                    <div>Sorry, I encountered an error. Please try again.</div>
                `;
                chatArea.appendChild(errorDiv);
            }

            isLoading = false;
            sendButton.disabled = false;
            chatArea.scrollTop = chatArea.scrollHeight;
            input.focus();
        }

        // Enter key handler
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Session management
        async function initializeSession() {
            if (!sessionId) {
                try {
                    const response = await fetch('/api/session/new');
                    const data = await response.json();
                    sessionId = data.session_id;
                    console.log('Session initialized:', sessionId);
                } catch (error) {
                    console.error('Failed to initialize session:', error);
                }
            }
        }

        // File upload functionality
        let currentFileContent = null;
        let currentFileName = null;

        // File input change handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Drag and drop handlers
        const dropZone = document.getElementById('fileDropZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropZone.classList.add('drag-over');
        }

        function unhighlight(e) {
            dropZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        }

        async function handleFileUpload(file) {
            clearFileError();
            
            // Initialize session if needed
            if (!sessionId) {
                await initializeSession();
            }
            
            // Show loading in drop zone
            const dropZone = document.getElementById('fileDropZone');
            const originalContent = dropZone.innerHTML;
            dropZone.innerHTML = `
                <div class="drop-icon">‚è≥</div>
                <p><strong>Uploading ${file.name}...</strong></p>
            `;

            try {
                const formData = new FormData();
                formData.append('file', file);
                if (sessionId) {
                    formData.append('session_id', sessionId);
                }

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update session ID if provided
                    if (result.session_id) {
                        sessionId = result.session_id;
                    }
                    
                    showFilePreview(result);
                    currentFileContent = result.full_content;
                    currentFileName = result.filename;
                } else {
                    showFileError(result.error || 'Upload failed');
                }
            } catch (error) {
                showFileError(`Upload error: ${error.message}`);
            } finally {
                // Restore drop zone
                dropZone.innerHTML = originalContent;
            }
        }

        function showFilePreview(fileData) {
            const preview = document.getElementById('filePreview');
            const fileSize = (fileData.file_size / 1024).toFixed(1);
            
            preview.innerHTML = `
                <div class="file-preview">
                    <div class="file-header">
                        <span>üìÑ ${fileData.filename} (${fileSize} KB)</span>
                        <span>${fileData.content_type}</span>
                    </div>
                    <div class="file-attachment-info">
                        <p>‚úÖ File attached - content will be included with your next message</p>
                    </div>
                    <div class="file-actions">
                        <button onclick="clearFilePreview()">‚ùå Remove attachment</button>
                    </div>
                </div>
            `;
            preview.style.display = 'block';
        }

        function showFileError(error) {
            const errorDiv = document.getElementById('fileError');
            errorDiv.className = 'file-error';
            errorDiv.textContent = error;
            errorDiv.style.display = 'block';
        }

        function clearFileError() {
            const errorDiv = document.getElementById('fileError');
            errorDiv.style.display = 'none';
        }

        function clearFilePreview() {
            document.getElementById('filePreview').style.display = 'none';
            currentFileContent = null;
            currentFileName = null;
            document.getElementById('fileInput').value = '';
        }



        // Initialize
        checkStatus();
        initializeSession();
        document.getElementById('messageInput').focus();
    </script>
</body>
</html>